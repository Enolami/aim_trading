import { Button, VerticalBox, ScrollView, ListView, HorizontalBox, GridBox, ComboBox } from "std-widgets.slint";
import { ListComboBox } from "../sentiment/sentiment_component.slint";

// -------------------------------------------------------------------------
// 2. GLOBAL STYLES
// -------------------------------------------------------------------------
global Palette {
    out property <color> bg-color: #111111;
    out property <color> card-bg: #1A1A1A;
    out property <color> sidebar-bg: #1E1E1E;
    
    out property <color> text-primary: #FFFFFF;
    out property <color> text-secondary: #AAAAAA;
    out property <color> text-muted: #666666;

    // Chart Zones
    out property <color> zone-overbought: #371b24;
    out property <color> zone-strong: #291d26;     
    out property <color> zone-neutral: #1b1e27;  
    out property <color> zone-weak: #1a2b2e; 
    out property <color> zone-oversold: #1a3834;
    // Accents
    out property <color> accent-blue: #4F46E5;
    out property <color> accent-cyan: #06B6D4;
    out property <color> accent-green: #10B981;
    out property <color> accent-red: #EF4444;
    out property <color> accent-grey: #B0B3B8;

    //MA accent
    out property <color> ma-verylow: #16a24b;
    out property <color> ma-low: #4bdd80;
    out property <color> ma-mid: #facd14;
    out property <color> ma-high: #f97314;
    out property <color> ma-veryhigh: #dd2627;
}


export struct RsiData {
    symbol: string,
    rsi14: string,    // Table displays text
    price: string,    // Table displays text
    vhtt: string,     // Table displays text (Market Cap)
}

export struct CoinData {
    symbol: string,
    rsi: float,       // For color logic
    x: float,         // Horizontal position (0.0 to 1.0) based on Market Cap
    y: float,         // Vertical position (0.0 to 1.0) based on RSI
}

export struct MaData {
    symbol: string,
    ma50: string,       
    price: string,         
    vhtt: string,         
}

// -------------------------------------------------------------------------
// 3. COMPONENTS
// -------------------------------------------------------------------------
export component MySlider inherits Rectangle {
    in-out property<float> maximum: 100;
    in-out property<float> minimum: 0;
    in-out property<float> value;

    height: 6px; 
    border-radius: root.height/2;
    //background: @linear-gradient(90deg, #08fc01 0%, #aaaa00 50%, #f70501 100%);
    background: @linear-gradient(90deg, #f70501 0%, #aaaa00 50%, #08fc01 100%);
    horizontal-stretch: 1;
    min-width: 50px; 

    handle := Rectangle {
        width: 14px;
        height: 14px;
        border-radius: self.height / 2;
        background: white;
        border-width: 1px;
        border-color: #999;
        y: (parent.height - self.height) / 2;
        x: (root.width - handle.width) * (root.value - root.minimum)/(root.maximum - root.minimum);
    }
}

export component SliderCard inherits Rectangle {
    in-out property <string> title: "Quá Mua và Quá Bán";
    in-out property <string> left-text: "Quá Mua";
    in-out property <string> right-text: "Quá Bán";
    in-out property <float> left-value: 0.0;
    in-out property <float> right-value: 0.0;

    horizontal-stretch: 1;
    min-width: 20px; 
    
    height: 100px;
    background: Palette.card-bg;
    border-radius: 8px;
    padding: 15px;
    VerticalLayout {
        spacing: 5px;
        Text {
            text: root.title;
            color: white;
            font-weight: 700;
            font-size: 14px;
            horizontal-alignment: center;
            overflow: elide;
        }

        Rectangle { vertical-stretch: 1;} 

        HorizontalLayout {            
            VerticalLayout {
                alignment: start;
                spacing: 2px;
                Text {
                    text: root.left-value + "%";
                    color: #cccccc;
                    font-size: 20px;
                    font-weight: 500;
                }
                Text {
                    text: root.left-text;
                    color: #777777;
                    font-size: 10px;
                }
            }
            Rectangle { horizontal-stretch: 1;
            }
            VerticalLayout {
                spacing: 2px;
                alignment: end;
                Text {
                    text: root.right-value + "%";
                    color: #cccccc;
                    font-size: 20px;
                    font-weight: 500;
                    horizontal-alignment: right;
                }
                Text {
                    text: root.right-text;
                    color: #777777;
                    font-size: 10px;
                    horizontal-alignment: right;
                }
            }
        }

        MySlider {
            value: (root.left-value + root.right-value) > 0 ? 
                   (root.right-value / (root.left-value + root.right-value) * 100) : 50;
            
            minimum: 0;
            maximum: 100;
        }
        Rectangle { height: 5px;
        } 
    }
}

component TableRow {
    in property <string> symbol;
    in property <string> name;
    in property <string> rsi14;
    in property <string> rsi21;
    in property <bool> is-header: false;

    callback sort_title();
    Rectangle {
        height: 35px;
        background: transparent;
        HorizontalLayout {
            padding-left: 10px;
            padding-right: 10px;
            spacing: 10px;
            Text { 
                text: root.symbol;
                width: 15%; 
                overflow: elide;
                color: root.is-header ? Palette.text-secondary : Palette.text-primary; 
                font-weight: root.is-header ? 400 : 700;
                vertical-alignment: center;
            }
            Text { 
                text: root.name;
                horizontal-stretch: 1;
                overflow: elide;
                color: Palette.text-secondary; 
                vertical-alignment: center;
            }
            TouchArea {
                enabled: root.rsi14 == "RSI 14" || root.rsi14 == "MA50";
                mouse-cursor: self.enabled ? pointer : default;
                clicked => {if self.enabled { sort_title(); }};
                width: 15%;
                Text { 
                    text: root.rsi14;
                    //width: 15%; 
                    color: root.is-header ? Palette.text-secondary : Palette.accent-cyan; 
                    vertical-alignment: center;
                }
            }
            Text { 
                text: root.rsi21;
                width: 15%; 
                color: root.is-header ? Palette.text-secondary : Palette.accent-green; 
                vertical-alignment: center;
            }
        }
        Rectangle {
            y: parent.height - 1px;
            height: 1px;
            background: #333;
            visible: root.is-header;
        }
    }
}

component CryptoDot inherits Rectangle {
    in property <float> rsi;
    in property <string> symbol;
    
    width: 8px;
    height: 8px;
    border-radius: 4px;
    background: 
        rsi >= 70 ?
        Palette.accent-red : 
        rsi <= 30 ?
        Palette.accent-green : 
        Palette.accent-grey;

    border-width: 1px;
    border-color: self.background.with-alpha(0.5);
    Text {
        text: root.symbol;
        color: Palette.text-primary;
        font-size: 8px;
        x: (parent.width - self.width) / 2;
        y: -10px;
        opacity: 0.7;
    }
}

component MaCryptoDot inherits Rectangle {
    in property <float> rsi;
    in property <string> symbol;
    
    width: 8px;
    height: 8px;
    border-radius: 4px;
    
    background: 
        rsi >= 80 ? Palette.ma-veryhigh : 
        rsi >= 60 ? Palette.ma-high :     
        rsi >= 40 ? Palette.ma-mid :      
        rsi >= 20 ? Palette.ma-low :      
        Palette.ma-verylow;               

    border-width: 1px;
    border-color: self.background.with-alpha(0.5);
    Text {
        text: root.symbol;
        color: Palette.text-primary;
        font-size: 8px;
        x: (parent.width - self.width) / 2;
        y: -10px;
        opacity: 0.7;
    }
}

export component RsiHeatmapChart inherits Rectangle {
    background: Palette.card-bg;
    border-radius: 8px;
    
    in property <[CoinData]> coins;

    VerticalLayout {
        padding: 15px;
        spacing: 10px;
        HorizontalLayout {
            Text { text: "Crypto RSI Heatmap ";
            color: Palette.text-primary; font-weight: 700; font-size: 14px; }
            Rectangle { horizontal-stretch: 1;
            }
            ListComboBox {
                model: ["8h", "16h", "24", "48h"];
                current-index: 0;
                width: 100px;
            }
        }

        HorizontalLayout {
            spacing: 5px;
            vertical-stretch: 1; 
            
            Rectangle {
                horizontal-stretch: 1;
                vertical-stretch: 1;
                
                VerticalLayout {
                    width: 100%;
                    height: 100%;
                    Rectangle { background: Palette.zone-overbought; vertical-stretch: 30; }
                    Rectangle { background: Palette.zone-strong; vertical-stretch: 10; }
                    Rectangle { background: Palette.zone-neutral; vertical-stretch: 20; }
                    Rectangle { background: Palette.zone-weak; vertical-stretch: 10; }
                    Rectangle { background: Palette.zone-oversold; vertical-stretch: 30; }
                }               

                for i in 10 : Rectangle {
                    height: 1px;
                    background: #ffffff10;
                    y: parent.height * (i / 10);
                }

                for i in 6 : Rectangle {
                    width: 1.5px;
                    background: #ffffff05;
                    x: parent.width * (i / 6);
                }

                Rectangle {
                    Text {text: "Overbought"; color: Palette.text-muted;font-weight: 600; x: parent.width - 68px; y: parent.height * 0.135;}
                    Text {text: "Strong"; color: Palette.text-muted;font-weight: 600; x: parent.width - 40px; y: parent.height * 0.335;}
                    Text {text: "Neutral"; color: Palette.text-muted;font-weight: 600; x: parent.width - 43px; y: parent.height * 0.4875;}
                    Text {text: "Weak"; color: Palette.text-muted;font-weight: 600; x: parent.width - 33px; y: parent.height * 0.65;}
                    Text {text: "Oversold"; color: Palette.text-muted;font-weight: 600; x: parent.width - 53px; y: parent.height * 0.835;}
                }

                for coin in root.coins : CryptoDot {
                    symbol: coin.symbol;
                    rsi: coin.rsi;
                    x: parent.width * coin.x;
                    y: parent.height * coin.y;
                }

                Rectangle {
                    y: parent.height;
                    height: 15px;
                    width: parent.width;
                    Text { text: "$10T"; color: Palette.text-muted; font-size: 9px; font-weight: 600; x: 0;}
                    Text { text: "$1T"; color: Palette.text-muted; font-size: 9px; font-weight: 600; x: parent.width * 0.162; }
                    Text { text: "$100B"; color: Palette.text-muted; font-size: 9px; font-weight: 600; x: parent.width * 0.325; }
                    Text { text: "$10B"; color: Palette.text-muted; font-size: 9px; font-weight: 600; x: parent.width * 0.495; }
                    Text { text: "$1B"; color: Palette.text-muted; font-size: 9px; font-weight: 600; x: parent.width * 0.664; }
                    Text { text: "$100M"; color: Palette.text-muted; font-size: 9px; font-weight: 600; x: parent.width * 0.825; }
                    Text { text: "$10M"; color: Palette.text-muted; font-size: 9px; font-weight: 600; x: parent.width * 0.99; }                    
                }
            }

            VerticalLayout {
                alignment: space-between;
                width: 20px;
                Text { text: "100"; font-size: 9px; color: Palette.text-muted;}
                Text { text: "90"; font-size: 9px; color: Palette.text-muted;}
                Text { text: "80"; font-size: 9px; color: Palette.text-muted;}
                Text { text: "70"; font-size: 9px; color: Palette.text-muted; }
                Text { text: "60"; font-size: 9px; color: Palette.text-muted;}
                Text { text: "50"; font-size: 9px; color: Palette.text-muted; }
                Text { text: "40"; font-size: 9px; color: Palette.text-muted;}
                Text { text: "30"; font-size: 9px; color: Palette.text-muted; }
                Text { text: "20"; font-size: 9px; color: Palette.text-muted;}
                Text { text: "10"; font-size: 9px; color: Palette.text-muted;}
                Text { text: "0"; font-size: 9px; color: Palette.text-muted; }
            }
        }

        Rectangle {
            x: parent.width * 0.5;
            Text {text: "Market Cap (USD)"; font-weight: 600; color: Palette.text-muted;}
        }
    }
}

component MaHeatmapChart inherits Rectangle {
    background: Palette.card-bg;
    border-radius: 8px;
    
    in property <[CoinData]> coins;

    VerticalLayout {
        padding: 15px;
        spacing: 10px;
        HorizontalLayout {
            Text { text: "Biểu đồ Heatmap Chỉ số MA50";
            color: Palette.text-primary; font-weight: 700; font-size: 14px; }
            Rectangle { horizontal-stretch: 1;
            }
            Text { text: "Ngành: "; color: Palette.text-secondary;
            font-size: 10px; vertical-alignment: center; }
            ListComboBox {
                model: ["Tất cả", "Ngân hàng", "Chứng khoán" ];
                current-index: 0;
                width: 100px;
            }
            Text { text: "Sàn: ";
            color: Palette.text-secondary; font-size: 10px; vertical-alignment: center; }
            ListComboBox {
                model: ["Tất cả", "Ngân hàng", "Chứng khoán" ];
                current-index: 0;
                width: 100px;
            }
            ListComboBox {
                model: ["Hôm nay", "Tuần này", "Tháng này" ];
                current-index: 0;
                width: 100px;
            }
        }

        HorizontalLayout {
            spacing: 5px;
            vertical-stretch: 1; 
            
            Rectangle {
                width: 15px;
                Text { 
                    text: "Độ lệch chuẩn";
                    transform-rotation: -90deg;
                    color: Palette.text-muted;
                    font-size: 10px;
                    //width: 15px;
                    vertical-alignment: center;
                }
            }

            Rectangle {
                horizontal-stretch: 1;
                vertical-stretch: 1;
                Rectangle {
                    background: Palette.zone-overbought;
                    border-width: 1px;
                }
                Rectangle {
                    y: parent.height * 0.5;
                    height: parent.height * 0.5;
                    background: Palette.zone-oversold;
                    border-width: 1px;
                }

                for i in 4 : Rectangle {
                    width: 1px;
                    background: #ffffff05;
                    x: parent.width * (i * 0.25);
                }

                for i in 7 : Rectangle {
                    height: 1px;
                    background: #ffffff10;
                    y: parent.height * (i * 1/6);
                }

                for coin in root.coins : MaCryptoDot {
                    symbol: coin.symbol;
                    rsi: coin.rsi;
                    x: parent.width * coin.x;
                    y: parent.height * coin.y;
                }

                Rectangle {
                    y: parent.height;
                    height: 25px;

                    Text { text: "1.000.000"; color: Palette.text-muted; font-size: 8px; x: 0;}
                    Text { text: "100.000"; color: Palette.text-muted; font-size: 8px; x: parent.width * 0.25 - 15px; }
                    Text { text: "10.000"; color: Palette.text-muted; font-size: 8px; x: parent.width * 0.50 - 10px; }
                    Text { text: "1.000"; color: Palette.text-muted; font-size: 8px; x: parent.width * 0.75 - 5px; }
                    Text { text: "100"; color: Palette.text-muted; font-size: 8px; x: parent.width - 15px; }
                    Text {
                        text: "Vốn hóa thị trường (Tỷ VNĐ)";
                        color: Palette.text-muted;
                        font-size: 9px;

                        x: (parent.width - self.width) / 2;
                        y: parent.height - 5px;
                    }
                }

                
            }

            Rectangle {
                width: 20px;
                Text { text: "0"; font-size: 15px; color: Palette.text-muted;} 
                Text { text: "+1"; y: parent.height * 1/3 - 8px; font-size: 15px; color: Palette.text-muted;}
                Text { text: "+2"; y: parent.height * 1/6 - 8px; font-size: 15px; color: Palette.text-muted;}
                Text { text: "-1"; y: parent.height * 2/3 - 8px; font-size: 15px; color: Palette.text-muted;}
                Text { text: "-2"; y: parent.height * 5/6 - 8px; font-size: 15px; color: Palette.text-muted;}
            }
        }

        Rectangle { height: 20px; }

        HorizontalLayout {
            alignment: center;
            spacing: 5px;
            Text { text: "Chỉ số MA50: Thấp"; font-size: 10px; color: Palette.text-muted;
            }
            Rectangle { width: 15px; height: 6px; border-radius: 3px; background: Palette.ma-verylow; }
            Rectangle { width: 15px; height: 6px; border-radius: 3px; background: Palette.ma-low; }
            Rectangle { width: 15px; height: 6px; border-radius: 3px; background: Palette.ma-mid; }
            Rectangle { width: 15px; height: 6px; border-radius: 3px; background: Palette.ma-high; }
            Rectangle { width: 15px; height: 6px; border-radius: 3px; background: Palette.ma-veryhigh; }
            Text { text: "Cao"; font-size: 10px; color: Palette.text-muted; }
        }
    }
}

// -------------------------------------------------------------------------
// 4. MAIN LAYOUT
// -------------------------------------------------------------------------
export component MP inherits Rectangle {
    in-out property <int> selected_tab: 3;
    in property <[RsiData]> rsi_list;
    in property <[CoinData]> coin_list;

    in property <[MaData]> ma_list;
    in property <[CoinData]> ma_coin_list;

    in property <float> rsi_overbought_pct: 0.0;
    in property <float> rsi_oversold_pct: 0.0;
    
    in property <float> ma_above_pct: 0.0;
    in property <float> ma_below_pct: 0.0;

    callback sort_rsi14();
    callback sort_ma50();
    
    preferred-width: 1200px;
    preferred-height: 800px;
    min-width: 800px;
    min-height: 400px;
    
    background: Palette.bg-color;
    VerticalLayout {
        Rectangle {
            vertical-stretch: 1;
            HorizontalLayout {
                // --- Sidebar ---
                Rectangle {
                    width: 220px;
                    // Fixed width sidebar
                    background: Palette.sidebar-bg;
                    VerticalLayout {
                        padding: 20px;
                        spacing: 20px;

                        Text {
                            text: "Chỉ báo kỹ thuật";
                            color: Palette.text-secondary;
                            font-size: 14px;
                        }

                        Rectangle {
                            height: 40px;
                            background: Palette.accent-blue;
                            border-radius: 4px;
                            Text {
                                text: "RSI và MA";
                                color: white;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                            TouchArea { mouse-cursor: pointer;
                            }
                        }

                        Rectangle { vertical-stretch: 1;
                        }
                        Rectangle { height: 20px;
                        }
                    }
                }

                // --- Main Content ---
                VerticalLayout {
                    GridLayout {
      
                        padding: 10px;
                        spacing: 10px;

                        // RSI table
                        Rectangle {
                            background: Palette.card-bg;
                            border-radius: 8px;
                            col: 0; row: 0;
                            horizontal-stretch: 1; 
                            vertical-stretch: 1;
                            VerticalLayout {
                                padding: 15px;
                                spacing: 10px;

                                HorizontalLayout {
                                    spacing: 10px;
                                    // Top Left Slider: Binds to properties
                                    SliderCard {
                                        title: "Quá Mua và Quá Bán";
                                        left-text: "Quá Bán"; 
                                        right-text: "Quá Mua"; 
                                        left-value: root.rsi_oversold_pct;
                                        right-value: root.rsi_overbought_pct;
                                    } 
                                }

                             
                                TableRow { symbol: "Symbol"; name: "Market Cap"; rsi14: "RSI 14"; rsi21: "Price"; is-header: true;
                                sort_title => {root.sort_rsi14()}}
                                
                                Text { text: "Items: " + root.rsi_list.length;
                                color: #888; font-size: 10px; }

                                ListView {
                                    vertical-stretch: 1;
                                    for item in root.rsi_list : TableRow {
                                        symbol: item.symbol;
                                        name: item.vhtt;
                                        rsi14: item.rsi14;
                                        rsi21: item.price;
                                    }
                                }
                            }
                        }

          
                        // Chart
                        RsiHeatmapChart {
                            coins: root.coin_list;
                            col: 1; row: 0;
                            horizontal-stretch: 3; 
                        }

                        // MA table
                        Rectangle {
                            background: Palette.card-bg;
                            border-radius: 8px;
                            col: 0; row: 1;
                            vertical-stretch: 1;
                            
                            VerticalLayout {
                                padding: 15px;
                                spacing: 10px;

                                HorizontalLayout {
                                    spacing: 10px;
                                    SliderCard {
                                        title: "Giá CP so với MA50";
                                        left-text: "Dưới MA";
                                        right-text: "Trên MA";
                                        left-value: root.ma_below_pct;
                                        right-value: root.ma_above_pct;
                                    }
                                }

                                TableRow { symbol: "Symbol";
                                name: "Market Cap"; rsi14: "MA50"; rsi21: "Value"; is-header: true;
                                sort_title => {root.sort_ma50()}}
                                
                                ListView {
                                    for item in root.ma_list : TableRow {
                                        symbol: item.symbol;
                                        name: item.vhtt; 
                                        rsi14: item.ma50;
                                        rsi21: item.price;
                                    }
                                }
                            }
                        }
          
                        // Chart
                        MaHeatmapChart {
                            coins: root.ma_coin_list;
                            col: 1;
                            row: 1;
                        }
                    }
                }
            }
        }
    }
}